{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Zone — SafeTour</title>

  <!-- Leaflet + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

  <!-- Leaflet + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

  <style>
    :root {
      --gap: 14px;
      --panel-bg: #b4d4f7;
      --muted: #6b7280;
      --accent: #2563eb; /* blue-600 */
      --accent-600: #1d4ed8;
      --surface: #f8fafc;
      --card-border: #e6eefc;
      --radius: 12px;
      --glass: rgba(255,255,255,0.7);
    }

    html, body { height:100%; margin:0; padding:0; }
    body { font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#f6f8fb 0%, #fbfdff 100%); color:#0f172a; box-sizing:border-box; padding:14px; }

    /* Layout */
    .layout { display:flex; gap:var(--gap); height: calc(100vh - 28px); min-height:0; }
    .map-col { flex:3 1 0; min-width:0; }
    .form-col { flex:1 0 380px; max-width:460px; background:transparent; display:flex; flex-direction:column; }

    /* card wrapper to allow shadow separation from map */
    .panel { background:linear-gradient(270deg,var(--panel-bg),var(--glass)); border-radius:var(--radius); box-shadow:0 12px 36px rgba(15,23,42,0.08); border:1px solid var(--card-border); overflow:hidden; display:flex; flex-direction:column; height:100%; }

    /* Map */
    #map { width:100%; height:100%; border-radius:12px; border:1px solid rgba(15,23,42,0.04); box-shadow:inset 0 -1px 0 rgba(15,23,42,0.02); }

    /* Form body */
    .form-body { padding:16px; overflow:auto; display:flex; flex-direction:column; gap:14px; }

    /* Messages */
    .messages { margin-bottom: 6px; }
    .message { padding:10px 12px; border-radius:8px; margin-bottom:8px; font-size:0.95rem; }
    .message.error { background:#fff1f2; border:1px solid #fecaca; color:#7f1d1d; }
    .message.success { background:#ecfdf5; border:1px solid #bbf7d0; color:#065f46; }

    /* Headings */
    h2 { font-size:16px; margin:0; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    h3 { margin:0; }
    .small { font-size:0.9rem; color:var(--muted); }

    /* Forms */
    label { display:block; font-weight:600; margin-bottom:6px; font-size:0.92rem; color:#0f172a; }
    input[type="text"], input[type="number"], input[type="time"], textarea, select {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6eef8; font-size:0.95rem; box-sizing:border-box; background:linear-gradient(180deg,#fff 0%, #fbfdff 100%);
      transition:box-shadow .18s cubic-bezier(.2,.9,.3,1), border-color .12s ease, transform .08s ease;
    }
    input[type="text"]::placeholder, textarea::placeholder { color:#9aa6bf; }
    input:focus, textarea:focus, select:focus { outline:none; box-shadow:0 10px 30px rgba(37,99,235,0.08); border-color:var(--accent-600); transform:translateY(-2px); }
    textarea { min-height:90px; resize:vertical; }

    /* Buttons */
    .btn { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--accent); background:var(--accent); color:#fff; cursor:pointer; text-decoration:none; font-weight:600; transition:transform .12s ease, box-shadow .12s ease; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(37,99,235,0.12); }
    .btn:active { transform:translateY(0); }
    .btn-outline { background:transparent; color:var(--accent); border-color:var(--accent); }
    .btn-ghost { background:transparent; border:1px dashed #e2e8f0; color:#0f172a; }

    .card { background:#fff; padding:14px; border-radius:12px; border:1px solid #eef2ff; margin-bottom:12px; transition:transform .12s ease, box-shadow .12s ease; }
    .card:hover { transform:translateY(-4px); box-shadow:0 12px 30px rgba(12,18,44,0.06); }
    .type-block, .alert-row { border:1px solid #f1f5f9; padding:12px; border-radius:10px; margin-bottom:10px; background:linear-gradient(180deg,#fff 0%, #fbfdff 100%); position:relative; }

    .coords { font-family:monospace; color:#0f172a; background:#f8fafc; padding:6px 10px; border-radius:8px; display:inline-block; box-shadow:0 1px 0 rgba(15,23,42,0.02); }
    .muted { color:var(--muted); font-size:0.9rem; }

    .zone-actions { display:flex; gap:8px; align-items:center; }

    /* remove button for type blocks */
    .type-remove { position:absolute; right:12px; top:12px; border-radius:8px; padding:6px 8px; background:#fff; border:1px solid #f1f5f9; cursor:pointer; color:#b91c1c; font-weight:700; }
    .type-remove:hover { background:#fff6f6; transform:translateY(-2px); }

    /* collapsible content */
    .type-block .body { margin-top:10px; }
    .type-block.collapsed { max-height:56px; overflow:hidden; }

    /* Sticky header within right panel */
    .panel-header { position:sticky; top:12px; background:transparent; z-index:4; padding:12px 16px; }

    /* compact grid for form rows */
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center; }
    .form-row.single { grid-template-columns:1fr; }

    /* zone preview animation */
    #zoneInfo { transition:transform .18s ease, opacity .18s ease; transform-origin:top right; }

    /* responsive tweaks */
    @media (max-width:980px) {
      .layout { flex-direction:column; height:auto; }
      .map-col, .form-col { width:100%; flex:none; }
      #map { height:420px; }
      .form-col { max-width:none; }
      .panel-header { position:relative; top:auto; }
    }
  </style>
</head>
<body>

  <div class="layout">
    <!-- LEFT: MAP -->
    <div class="map-col">
      <div id="map"></div>
    </div>

    <!-- RIGHT: FORM (scrollable) -->
    <div class="form-col">
      <div class='panel'>
        <div class="panel-header">
          <div class="form-body">
            {# show Django messages so user sees formset/field errors #}
            <div class="messages">
              {% if messages %}
                {% for m in messages %}
                  <div class="message {% if m.tags %}{{ m.tags }}{% endif %}">{{ m }}</div>
                {% endfor %}
              {% endif %}
            </div>

            <form method="post" id="zone-form" novalidate>
              {% csrf_token %}

              <!-- Management forms (render exactly once) -->
              <div id="management-forms" style="display:none;">
                {{ types_formset.management_form }}
                {{ alerts_formset.management_form }}
              </div>

              <!-- Zone card with action buttons (Clear + Use my location) -->
              <div class="card">
                <h2>
                  <span>Zone</span>
                  <span class="zone-actions">
                    <button type="button" id="clearMapBtn" class="btn btn-outline" title="Clear map">Clear</button>
                    <button type="button" id="locateBtn" class="btn btn-outline" title="Use my location">Use my location</button>
                  </span>
                </h2>

                <div style="margin-top:10px;">
                  {% csrf_token %}
                  {{ zone_form.as_p }}
                  <!-- optional: hidden field to save polygon points if user draws polygon -->
                  <input type="hidden" name="zone-polygon_points" id="id_zone-polygon_points" />
                </div>

                
              </div>

              <!-- Zone Types -->
              <div class="card">
                <h2 style="margin-bottom:8px;">
                  <span>Zone Types</span>
                  <button type="button" id="add-type" class="btn btn-outline" style="height:34px;">+ Add Type</button>
                </h2>

                <div id="types-area">
                  {% csrf_token %}
                  {% for form in types_formset.forms %}
                    <div class="type-block" data-type-index="{{ forloop.counter0 }}">
                      <strong>Type #{{ forloop.counter }}</strong>
                      <div style="margin-top:6px;">
                        {% csrf_token %}
                        {{ form.name.label_tag }} {{ form.name }}
                        {% if form.id %}{{ form.id }}{% endif %}
                        {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                        {% if form.non_field_errors %}<div class="message error">{{ form.non_field_errors }}</div>{% endif %}
                        {% for f in form.visible_fields %}
                          {% if f.errors %}<div class="message error">{{ f.errors }}</div>{% endif %}
                        {% endfor %}
                      </div>

                      <div class="alerts-list" id="alerts-for-type-{{ forloop.counter0 }}" style="margin-top:8px;">
                        <h4 style="margin:0 0 8px 0; display:flex; justify-content:space-between; align-items:center;">
                          <span>Alerts</span>
                          <button type="button" class="add-alert btn btn-outline" data-type-index="{{ forloop.counter0 }}" style="height:30px;">+ Add Alert</button>
                        </h4>
                        <!-- alerts rows are added client-side -->
                      </div>
                    </div>
                  {% empty %}
                    <!-- empty: no server-side types initially -->
                  {% endfor %}
                </div>
              </div>

              <!-- alerts container (JS appends generated alert rows here) -->
              <div id="alerts-area" style="display:none;"></div>

              <div style="text-align:right; margin-top:6px;">
                <button type="submit" class="btn">Save Zone + Types + Alerts</button>
              </div>
            </form>

            <!-- Zone Info preview (optional) -->
            <div id="zoneInfo" class="card" style="display:none; margin-top:12px;">
              <h2 id="zoneInfoTitle">Zone details</h2>
              <div id="zoneInfoBody" style="font-size:0.95rem; color:#222;"></div>
              <div style="margin-top:8px; text-align:right;">
                <button id="closeZoneInfoBtn" class="btn btn-outline">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet + draw + dependencies -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>

  (function () {
    // --- Server-provided constants (rendered by Django) ---
    const TYPES_PREFIX = "{{ types_formset.prefix }}";
    const ALERTS_PREFIX = "{{ alerts_formset.prefix }}";
    const TYPES_INITIAL = {{ types_formset.initial_form_count|default:"0" }};
    const ALERTS_INITIAL = {{ alerts_formset.initial_form_count|default:"0" }};

    // ------- DOM shortcuts & form fields -------
    const latField = document.querySelector('input[name="zone-latitude"]');
    const lngField = document.querySelector('input[name="zone-longitude"]');
    const radiusField = document.querySelector('input[name="zone-radius"]');
    const polyField = document.querySelector('input[name="zone-polygon_points"], textarea[name="zone-polygon_points"]');
    const coordsPreview = document.getElementById('coordsPreview');
    const radiusPreview = document.getElementById('radiusPreview');

    // ------- init map -------
    const map = L.map('map').setView([23.7272, 92.7173], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // feature group to hold a single user-drawn geometry
    const drawnFG = new L.FeatureGroup().addTo(map);
    let currentLayer = null;

    // Draw control — allow marker, circle, polygon
    const drawControl = new L.Control.Draw({
      draw: {
        polyline: false,
        rectangle: false,
        circlemarker: false,
        marker: true,
        circle: { showRadius: true },
        polygon: { allowIntersection: false, showArea: true }
      },
      edit: {
        featureGroup: drawnFG,
        edit: true,
        remove: true
      }
    });
    map.addControl(drawControl);
function drawCircleFromInputs() {
  const lat = parseFloat(latField.value);
  const lng = parseFloat(lngField.value);
  const radius = parseFloat(radiusField.value);

  if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
    // Remove previous layer
    if (currentLayer) {
      drawnFG.removeLayer(currentLayer);
      currentLayer = null;
    }

    // Create new circle
    const circle = L.circle([lat, lng], {
      radius: radius,
      color: 'red',
      fillColor: '#f03',
      fillOpacity: 0.4
    }).addTo(drawnFG);

    currentLayer = circle;

    // Zoom to circle
    map.fitBounds(circle.getBounds());
  } else {
    console.log("Coordinates or radius not ready yet:", { lat, lng, radius });
  }
}

// Example: trigger when inputs change
latField.addEventListener('input', drawCircleFromInputs);
lngField.addEventListener('input', drawCircleFromInputs);
radiusField.addEventListener('input', drawCircleFromInputs);
  
    // helper to set values into form fields (name-based)
    function setZoneFields(lat, lng, radius) {
      if (latField) latField.value = (lat === '' ? '' : Number(lat).toFixed(6));
      if (lngField) lngField.value = (lng === '' ? '' : Number(lng).toFixed(6));
      if (radiusField) radiusField.value = (radius === '' ? '' : String(radius));
      if (coordsPreview) coordsPreview.textContent = (lat && lng) ? `${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}` : '—';
      if (radiusPreview) radiusPreview.textContent = radius ? `${radius} m` : '—';
    }

    // compute polygon centroid (simple average) — fine for UI preview
    function polygonCentroid(latlngs) {
      let sx = 0, sy = 0, n = 0;
      latlngs.forEach(p => { sx += p.lat; sy += p.lng; n++; });
      return { lat: sx / n, lng: sy / n };
    }

    // update form from a Leaflet layer
    function updateFromLayer(layer, layerType) {
      if (!layer) { setZoneFields('', '', ''); if (polyField) polyField.value = ''; return; }
      if (layerType === 'circle' || layer instanceof L.Circle) {
        const c = layer.getLatLng();
        const r = Math.round(layer.getRadius());
        setZoneFields(c.lat, c.lng, r);
        if (polyField) polyField.value = '';
      } else if (layerType === 'polygon' || layer instanceof L.Polygon) {
        let latlngs = layer.getLatLngs();
        if (Array.isArray(latlngs[0])) latlngs = latlngs[0]; // ring
        const ctr = polygonCentroid(latlngs);
        setZoneFields(ctr.lat, ctr.lng, '');
        // save polygon points into hidden field if present
        if (polyField) {
          const pts = latlngs.map(p => `${p.lat.toFixed(6)} ${p.lng.toFixed(6)}`).join(';');
          polyField.value = pts;
        }
      } else { // marker
        const c = layer.getLatLng();
        setZoneFields(c.lat, c.lng, '');
        if (polyField) polyField.value = '';
      }
    }

    // map click → single marker
    map.on('click', function (e) {
      if (currentLayer) { drawnFG.removeLayer(currentLayer); currentLayer = null; }
      const marker = L.marker(e.latlng);
      currentLayer = marker;
      drawnFG.addLayer(marker);
      updateFromLayer(marker, 'marker');
    });

    // when a draw is created (marker/circle/polygon)
    map.on(L.Draw.Event.CREATED, function (e) {
      if (currentLayer) { drawnFG.removeLayer(currentLayer); currentLayer = null; }
      const layer = e.layer;
      currentLayer = layer;
      drawnFG.addLayer(layer);
      updateFromLayer(layer, e.layerType);
    });

    // when layer edited
    map.on('draw:edited', function (e) {
      e.layers.eachLayer(function (layer) {
        currentLayer = layer;
        updateFromLayer(layer, layer instanceof L.Circle ? 'circle' : (layer instanceof L.Marker ? 'marker' : 'polygon'));
      });
    });

    // when deleted (clear)
    map.on('draw:deleted', function () {
      drawnFG.clearLayers();
      currentLayer = null;
      setZoneFields('', '', '');
      if (polyField) polyField.value = '';
    });

    // Clear button (in zone card)
    document.getElementById('clearMapBtn').addEventListener('click', function () {
      drawnFG.clearLayers();
      currentLayer = null;
      setZoneFields('', '', '');
      if (polyField) polyField.value = '';
    });

    // Use my location (in zone card)
    document.getElementById('locateBtn').addEventListener('click', function () {
      if (!navigator.geolocation) { alert('Geolocation not available'); return; }
      navigator.geolocation.getCurrentPosition(function (pos) {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if (currentLayer) drawnFG.removeLayer(currentLayer);
        const mk = L.marker([lat, lng]).addTo(drawnFG);
        currentLayer = mk;
        map.setView([lat, lng], 14);
        updateFromLayer(mk, 'marker');
      }, function (err) {
        alert('Unable to access location: ' + err.message);
      });
    });

    // prefill (edit mode)
    (function prefill() {
      try {
        const lat = parseFloat(latField ? latField.value : '');
        const lng = parseFloat(lngField ? lngField.value : '');
        const rad = radiusField ? radiusField.value : '';
        if (!isNaN(lat) && !isNaN(lng)) {
          let layer;
          if (rad && String(rad).trim() !== '') {
            layer = L.circle([lat, lng], { radius: parseFloat(rad) });
          } else {
            layer = L.marker([lat, lng]);
          }
          currentLayer = layer;
          drawnFG.addLayer(layer);
          map.setView([lat, lng], 13);
          updateFromLayer(layer, layer instanceof L.Circle ? 'circle' : 'marker');
        }
      } catch (err) { /* ignore */ }
    })();

    // render / resize fixes
    window.addEventListener('resize', function () { setTimeout(() => map.invalidateSize(), 150); });
    setTimeout(() => map.invalidateSize(), 200);

    // ---------------------------
    // Dynamic formset JS for Types + Alerts
    // ---------------------------
    (function () {
      const typesPrefix = TYPES_PREFIX;
      const alertsPrefix = ALERTS_PREFIX;

      const typesArea = document.getElementById('types-area');
      const addTypeBtn = document.getElementById('add-type');
      const alertsArea = document.getElementById('alerts-area');

      function getInput(name) { return document.querySelector('[name=\"'+name+'\"]'); }
      function setInput(name, val){ const el = getInput(name); if(el) el.value = val; }
      function getTotalForms(prefix){ const el = getInput(prefix + '-TOTAL_FORMS'); return el ? parseInt(el.value || '0', 10) : 0; }

      function createTypeBlock(index){
        const wrapper = document.createElement('div');
        wrapper.className = 'type-block';
        wrapper.setAttribute('data-type-index', index);
        wrapper.innerHTML = `
          <strong>Type #${index + 1}</strong>
          <div style="margin-top:6px;">
            <label for="id_${typesPrefix}-${index}-name">Name:</label>
            <input type="text" name="${typesPrefix}-${index}-name" id="id_${typesPrefix}-${index}-name" />
            <input type="hidden" name="${typesPrefix}-${index}-DELETE" value="" />
          </div>

          <div class="alerts-list" id="alerts-for-type-${index}">
            <h4>Alerts
              <button type="button" class="add-alert btn btn-outline" data-type-index="${index}" style="float:right">+ Add Alert</button>
            </h4>
          </div>
        `;
        return wrapper;
      }

      function createAlertRow(globalIndex, typeIndex){
        const row = document.createElement('div');
        row.className = 'alert-row';
        row.setAttribute('data-alert-index', globalIndex);

        row.innerHTML = `
          <label>Start:</label>
          <input type="time" name="${alertsPrefix}-${globalIndex}-start_time" required />
          <label>End:</label>
          <input type="time" name="${alertsPrefix}-${globalIndex}-end_time" required />
          <label>Risk:</label>
          <input type="number" name="${alertsPrefix}-${globalIndex}-risk_points" min="0" max="100" required />
          <input type="hidden" name="${alertsPrefix}-${globalIndex}-type_index" value="${typeIndex}" />
          <input type="hidden" name="${alertsPrefix}-${globalIndex}-DELETE" value="" />
          <button type="button" class="remove-alert remove-btn btn btn-outline">Remove</button>
        `;
        return row;
      }

      if (addTypeBtn) {
        addTypeBtn.addEventListener('click', function(){
          let totalTypes = getTotalForms(typesPrefix);
          const newBlock = createTypeBlock(totalTypes);
          typesArea.appendChild(newBlock);
          setInput(typesPrefix + '-TOTAL_FORMS', totalTypes + 1);
        });
      }

      document.addEventListener('click', function(e){
        if (e.target && e.target.matches('.add-alert')) {
          const typeIndex = e.target.getAttribute('data-type-index');
          let alertsTotal = getTotalForms(alertsPrefix);
          const alertRow = createAlertRow(alertsTotal, typeIndex);
          const list = document.getElementById('alerts-for-type-' + typeIndex);
          if (list) {
            list.appendChild(alertRow);
          } else {
            alertsArea.appendChild(alertRow);
          }
          setInput(alertsPrefix + '-TOTAL_FORMS', alertsTotal + 1);
        }

        if (e.target && e.target.matches('.remove-alert')) {
          const row = e.target.closest('.alert-row');
          if (!row) return;
          const deleteInput = row.querySelector('input[name$="-DELETE"]');
          if (deleteInput) deleteInput.value = 'on';
          row.style.display = 'none';
        }
      });

      document.addEventListener('DOMContentLoaded', function(){
        if (!getInput(typesPrefix + '-TOTAL_FORMS')) {
          const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
          fields.forEach(f => {
            const el = document.createElement('input');
            el.type = 'hidden';
            el.name = `${typesPrefix}-${f}`;
            el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
            typesArea.insertBefore(el, typesArea.firstChild);
          });
        }
        if (!getInput(alertsPrefix + '-TOTAL_FORMS')) {
          const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
          fields.forEach(f => {
            const el = document.createElement('input');
            el.type = 'hidden';
            el.name = `${alertsPrefix}-${f}`;
            el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
            alertsArea.insertBefore(el, alertsArea.firstChild);
          });
        }
      });
    })();

    /* --- ensure management inputs exist and set sensible TOTAL_FORMS before submit --- */
    (function () {
      function ensureMgmtFor(prefix, initialVal) {
        const root = document.getElementById('management-forms') || document.getElementById('zone-form') || document.body;
        const names = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];

        // compute a reasonable TOTAL_FORMS from DOM:
        let total = 0;
        if (prefix === TYPES_PREFIX) {
          total = document.querySelectorAll(`[name^="${prefix}-"][name$="-name"]`).length;
          if (!total) total = document.querySelectorAll('.type-block').length;
        } else if (prefix === ALERTS_PREFIX) {
          total = document.querySelectorAll(`[name^="${prefix}-"][name$="-start_time"]`).length;
          if (!total) total = document.querySelectorAll('.alert-row').length;
        }
        total = total || 0;

        names.forEach(function(n) {
          const fieldName = `${prefix}-${n}`;
          const existing = document.querySelector(`[name="${fieldName}"]`);
          if (!existing) {
            const inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = fieldName;
            if (n === 'TOTAL_FORMS') {
              inp.value = String(total);
            } else if (n === 'INITIAL_FORMS') {
              inp.value = String(initialVal || 0);
            } else {
              inp.value = '0';
            }
            root.appendChild(inp);
          } else {
            if (n === 'TOTAL_FORMS') {
              existing.value = String(total);
            }
            // do NOT change INITIAL_FORMS (should reflect server-side initial count)
          }
        });
      }

      const zoneForm = document.getElementById('zone-form');
      if (zoneForm) {
        zoneForm.addEventListener('submit', function (ev) {
          ensureMgmtFor(TYPES_PREFIX, TYPES_INITIAL);
          ensureMgmtFor(ALERTS_PREFIX, ALERTS_INITIAL);

          // quick sanity-check (development help) — if critical inputs missing, prevent submit
          const missing = [];
          ['INITIAL_FORMS','TOTAL_FORMS'].forEach(key => {
            if (!document.querySelector(`[name="${TYPES_PREFIX}-${key}"]`)) missing.push(`${TYPES_PREFIX}-${key}`);
            if (!document.querySelector(`[name="${ALERTS_PREFIX}-${key}"]`)) missing.push(`${ALERTS_PREFIX}-${key}`);
          });
          if (missing.length) {
            // prevent submit so you can debug in dev; remove in production if desired
            ev.preventDefault();
            alert('Missing formset management inputs: ' + missing.join(', '));
            console.error('Missing formset management inputs at submit:', missing);
            return false;
          }
        });
      }
    })();

    // ---- end main IIFE ----
  })();
  </script>
</body>
</html>