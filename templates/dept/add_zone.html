{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Zone — SafeTour</title>

  <!-- Leaflet + Draw CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

  <style>
    :root { --gap: 14px; --panel-bg: #fff; --muted: #666; }
    html, body { height: 100%; margin:0; padding:0; }
    body { font-family: Inter, system-ui, Arial; background:#f6f7fb; color:#222; box-sizing: border-box; padding:12px; }

    /* Two-column full-height layout */
    .layout { display:flex; gap:var(--gap); height: calc(100vh - 24px); min-height:0; }

    /* Map column (left) and form column (right) */
    .map-col { flex: 3 1 0; min-width:0; }
    .form-col { flex: 1 0 360px; max-width:420px; background:var(--panel-bg); border:1px solid #e6e9ef; border-radius:8px; box-shadow:0 4px 10px rgba(20,20,40,0.03); overflow:hidden; display:flex; flex-direction:column; }

    /* Map should fill left column */
    #map { width:100%; height:100%; border-radius:8px; border:1px solid #ddd; display:block; }

    /* Form content scrolls independently */
    .form-body { padding:16px; overflow:auto; display:flex; flex-direction:column; gap:12px; }

    h1 { font-size:20px; margin:0 0 6px 0; }
    h2 { font-size:16px; margin:0; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .small { font-size:0.9rem; color:var(--muted); }
    label { display:block; font-weight:600; margin-bottom:6px; font-size:0.95rem; }
    input[type="text"], input[type="number"], input[type="time"], textarea, select { width:100%; padding:8px 10px; border-radius:6px; border:1px solid #d6d9e6; font-size:0.95rem; }
    textarea { min-height:80px; resize:vertical; }
    .btn { display:inline-block; padding:8px 12px; border-radius:6px; border:1px solid #2b6cb0; background:#2b6cb0; color:#fff; cursor:pointer; text-decoration:none; }
    .btn-outline { background:transparent; color:#2b6cb0; border-color:#2b6cb0; }
    .card { background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px; }
    .type-block, .alert-row { border:1px solid #f0f0f0; padding:8px; border-radius:6px; margin-bottom:8px; background:#fbfcff; }
    .coords { font-family:monospace; color:#1f2937; background:#f5f7fa; padding:6px 8px; border-radius:6px; display:inline-block; }
    .muted { color:#777; font-size:0.9rem; }

    /* Zone card actions (buttons) on the right of heading */
    .zone-actions { display:flex; gap:8px; align-items:center; }

    @media (max-width:900px) {
      .layout { flex-direction:column; height:auto; }
      .map-col, .form-col { width:100%; flex:none; }
      #map { height:420px; }
      .form-col { max-width:none; }
    }
  </style>
</head>
<body>

  <div class="layout">
    <!-- LEFT: MAP -->
    <div class="map-col">
      <div id="map"></div>
    </div>

    <!-- RIGHT: FORM (scrollable) -->
    <div class="form-col">
      <div class="form-body">
        <form method="post" id="zone-form" novalidate>
          {% csrf_token %}

          <!-- Management forms (render exactly once) -->
          <div id="management-forms" style="display:none;">
            {{ types_formset.management_form }}
            {{ alerts_formset.management_form }}
          </div>

          <!-- Zone card with action buttons (Clear + Use my location) -->
          <div class="card">
            <h2>
              <span>Zone</span>
              <span class="zone-actions">
                <button type="button" id="clearMapBtn" class="btn btn-outline" title="Clear map">Clear</button>
                <button type="button" id="locateBtn" class="btn btn-outline" title="Use my location">Use my location</button>
              </span>
            </h2>

            <div style="margin-top:10px;">
              {{ zone_form.as_p }}
            </div>


          </div>

          <!-- Zone Types -->
          <div class="card">
            <h2 style="margin-bottom:8px;">
              <span>Zone Types</span>
              <button type="button" id="add-type" class="btn btn-outline" style="height:34px;">+ Add Type</button>
            </h2>

            <div id="types-area">
              {% for form in types_formset.forms %}
                <div class="type-block" data-type-index="{{ forloop.counter0 }}">
                  <strong>Type #{{ forloop.counter }}</strong>
                  <div style="margin-top:6px;">
                    {{ form.name.label_tag }} {{ form.name }}
                    {{ form.id }} {{ form.DELETE }}
                  </div>

                  <div class="alerts-list" id="alerts-for-type-{{ forloop.counter0 }}" style="margin-top:8px;">
                    <h4 style="margin:0 0 8px 0; display:flex; justify-content:space-between; align-items:center;">
                      <span>Alerts</span>
                      <button type="button" class="add-alert btn btn-outline" data-type-index="{{ forloop.counter0 }}" style="height:30px;">+ Add Alert</button>
                    </h4>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- alerts container (JS appends generated alert rows here) -->
          <div id="alerts-area" style="display:none;"></div>

          <div style="text-align:right; margin-top:6px;">
            <button type="submit" class="btn">Save Zone + Types + Alerts</button>
          </div>
        </form>

        <!-- Zone Info preview (optional) -->
        <div id="zoneInfo" class="card" style="display:none; margin-top:12px;">
          <h2 id="zoneInfoTitle">Zone details</h2>
          <div id="zoneInfoBody" style="font-size:0.95rem; color:#222;"></div>
          <div style="margin-top:8px; text-align:right;">
            <button id="closeZoneInfoBtn" class="btn btn-outline">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Leaflet + draw + dependencies -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <script>
  (function () {
    // ------- DOM shortcuts & form fields -------
    const latField = document.querySelector('input[name="zone-latitude"]');
    const lngField = document.querySelector('input[name="zone-longitude"]');
    const radiusField = document.querySelector('input[name="zone-radius"]');
    const coordsPreview = document.getElementById('coordsPreview');
    const radiusPreview = document.getElementById('radiusPreview');

    // ------- init map -------
    const map = L.map('map').setView([23.7272, 92.7173], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // feature group to hold a single user-drawn geometry
    const drawnFG = new L.FeatureGroup().addTo(map);
    let currentLayer = null;

    // Draw control — allow marker, circle, polygon
    const drawControl = new L.Control.Draw({
      draw: {
        polyline: false,
        rectangle: false,
        circlemarker: false,
        marker: true,
        circle: { showRadius: true },
        polygon: { allowIntersection: false, showArea: true }
      },
      edit: {
        featureGroup: drawnFG,
        edit: true,
        remove: true
      }
    });
    map.addControl(drawControl);

    // helper to set values into form fields (name-based)
    function setZoneFields(lat, lng, radius) {
      if (latField) latField.value = (lat === '' ? '' : Number(lat).toFixed(6));
      if (lngField) lngField.value = (lng === '' ? '' : Number(lng).toFixed(6));
      if (radiusField) radiusField.value = (radius === '' ? '' : String(radius));
      if (coordsPreview) coordsPreview.textContent = (lat && lng) ? `${Number(lat).toFixed(6)}, ${Number(lng).toFixed(6)}` : '—';
      if (radiusPreview) radiusPreview.textContent = radius ? `${radius} m` : '—';
    }

    // compute polygon centroid (simple average) — fine for UI preview
    function polygonCentroid(latlngs) {
      let sx = 0, sy = 0, n = 0;
      latlngs.forEach(p => { sx += p.lat; sy += p.lng; n++; });
      return { lat: sx / n, lng: sy / n };
    }

    // update form from a Leaflet layer
    function updateFromLayer(layer, layerType) {
      if (!layer) { setZoneFields('', '', ''); return; }
      if (layerType === 'circle' || layer instanceof L.Circle) {
        const c = layer.getLatLng();
        const r = Math.round(layer.getRadius());
        setZoneFields(c.lat, c.lng, r);
      } else if (layerType === 'polygon' || layer instanceof L.Polygon) {
        let latlngs = layer.getLatLngs();
        if (Array.isArray(latlngs[0])) latlngs = latlngs[0]; // ring
        const ctr = polygonCentroid(latlngs);
        setZoneFields(ctr.lat, ctr.lng, '');
        // if you want to save polygon points, you can add a hidden input named 'zone-polygon_points'
        // and set its value here as "lat1 lng1;lat2 lng2;..."
        const polyField = document.querySelector('input[name="zone-polygon_points"], textarea[name="zone-polygon_points"]');
        if (polyField) {
          const pts = latlngs.map(p => `${p.lat.toFixed(6)} ${p.lng.toFixed(6)}`).join(';');
          polyField.value = pts;
        }
      } else { // marker
        const c = layer.getLatLng();
        setZoneFields(c.lat, c.lng, '');
      }
    }

    // handle click on map to put a marker (single)
    map.on('click', function (e) {
      if (currentLayer) { drawnFG.removeLayer(currentLayer); currentLayer = null; }
      const marker = L.marker(e.latlng);
      currentLayer = marker;
      drawnFG.addLayer(marker);
      updateFromLayer(marker, 'marker');
    });

    // when a draw is created (marker/circle/polygon)
    map.on(L.Draw.Event.CREATED, function (e) {
      if (currentLayer) { drawnFG.removeLayer(currentLayer); currentLayer = null; }
      const layer = e.layer;
      currentLayer = layer;
      drawnFG.addLayer(layer);
      updateFromLayer(layer, e.layerType);
    });

    // when layer edited
    map.on('draw:edited', function (e) {
      e.layers.eachLayer(function (layer) {
        currentLayer = layer;
        updateFromLayer(layer, layer instanceof L.Circle ? 'circle' : (layer instanceof L.Marker ? 'marker' : 'polygon'));
      });
    });

    // when deleted (clear)
    map.on('draw:deleted', function () {
      drawnFG.clearLayers();
      currentLayer = null;
      setZoneFields('', '', '');
    });

    // Clear button
    document.getElementById('clearMapBtn').addEventListener('click', function () {
      drawnFG.clearLayers();
      currentLayer = null;
      setZoneFields('', '', '');
    });

    // Use my location
    document.getElementById('locateBtn').addEventListener('click', function () {
      if (!navigator.geolocation) { alert('Geolocation not available'); return; }
      navigator.geolocation.getCurrentPosition(function (pos) {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if (currentLayer) drawnFG.removeLayer(currentLayer);
        const mk = L.marker([lat, lng]).addTo(drawnFG);
        currentLayer = mk;
        map.setView([lat, lng], 14);
        updateFromLayer(mk, 'marker');
      }, function (err) {
        alert('Unable to access location: ' + err.message);
      });
    });

    // ----- if the zone inputs contain initial values (edit mode), show them on map -----
    (function prefill() {
      try {
        const lat = parseFloat(latField ? latField.value : '');
        const lng = parseFloat(lngField ? lngField.value : '');
        const rad = radiusField ? radiusField.value : '';
        if (!isNaN(lat) && !isNaN(lng)) {
          let layer;
          if (rad && String(rad).trim() !== '') {
            layer = L.circle([lat, lng], { radius: parseFloat(rad) });
          } else {
            layer = L.marker([lat, lng]);
          }
          currentLayer = layer;
          drawnFG.addLayer(layer);
          map.setView([lat, lng], 13);
          updateFromLayer(layer, layer instanceof L.Circle ? 'circle' : 'marker');
        }
      } catch (err) { /* ignore */ }
    })();

    // ensure map renders correctly after CSS/layout changes
    window.addEventListener('resize', function () { setTimeout(() => map.invalidateSize(), 150); });
    // small initial invalidate to make map fill the column correctly
    setTimeout(() => map.invalidateSize(), 200);

    // ---------------------------
    // Dynamic formset JS for Types + Alerts (your code integrated)
    // ---------------------------
    (function () {
      const typesPrefix = "{{ types_formset.prefix }}";   // e.g., "types"
      const alertsPrefix = "{{ alerts_formset.prefix }}"; // e.g., "alerts"

      const typesArea = document.getElementById('types-area');
      const addTypeBtn = document.getElementById('add-type');
      const alertsArea = document.getElementById('alerts-area');

      function getInput(name) { return document.querySelector('[name="'+name+'"]'); }
      function setInput(name, val){ const el = getInput(name); if(el) el.value = val; }
      function getTotalForms(prefix){ const el = getInput(prefix + '-TOTAL_FORMS'); return el ? parseInt(el.value || '0', 10) : 0; }

      function createTypeBlock(index){
        const wrapper = document.createElement('div');
        wrapper.className = 'type-block';
        wrapper.setAttribute('data-type-index', index);
        wrapper.innerHTML = `
          <strong>Type #${index + 1}</strong>
          <div style="margin-top:6px;">
            <label for="id_${typesPrefix}-${index}-name">Name:</label>
            <input type="text" name="${typesPrefix}-${index}-name" id="id_${typesPrefix}-${index}-name" />
            <input type="hidden" name="${typesPrefix}-${index}-DELETE" value="" />
          </div>


          <div class="alerts-list" id="alerts-for-type-${index}">
            <h4>Alerts
              <button type="button" class="add-alert btn btn-outline" data-type-index="${index}" style="float:right">+ Add Alert</button>
            </h4>
          </div>
        `;
        return wrapper;
      }

      function createAlertRow(globalIndex, typeIndex){
        const row = document.createElement('div');
        row.className = 'alert-row';
        row.setAttribute('data-alert-index', globalIndex);

        row.innerHTML = `
          <label>Start:</label>
          <input type="time" name="${alertsPrefix}-${globalIndex}-start_time" required />
          <label>End:</label>
          <input type="time" name="${alertsPrefix}-${globalIndex}-end_time" required />
          <label>Risk:</label>
          <input type="number" name="${alertsPrefix}-${globalIndex}-risk_points" min="0" max="100" required />
          <input type="hidden" name="${alertsPrefix}-${globalIndex}-type_index" value="${typeIndex}" />
          <input type="hidden" name="${alertsPrefix}-${globalIndex}-DELETE" value="" />
          <button type="button" class="remove-alert remove-btn btn btn-outline">Remove</button>
        `;
        return row;
      }

      if (addTypeBtn) {
        addTypeBtn.addEventListener('click', function(){
          let totalTypes = getTotalForms(typesPrefix);
          const newBlock = createTypeBlock(totalTypes);
          typesArea.appendChild(newBlock);
          setInput(typesPrefix + '-TOTAL_FORMS', totalTypes + 1);
        });
      }

      document.addEventListener('click', function(e){
        if (e.target && e.target.matches('.add-alert')) {
          const typeIndex = e.target.getAttribute('data-type-index');
          let alertsTotal = getTotalForms(alertsPrefix);
          const alertRow = createAlertRow(alertsTotal, typeIndex);
          const list = document.getElementById('alerts-for-type-' + typeIndex);
          if (list) {
            list.appendChild(alertRow);
          } else {
            alertsArea.appendChild(alertRow);
          }
          setInput(alertsPrefix + '-TOTAL_FORMS', alertsTotal + 1);
        }

        if (e.target && e.target.matches('.remove-alert')) {
          const row = e.target.closest('.alert-row');
          if (!row) return;
          const deleteInput = row.querySelector('input[name$="-DELETE"]');
          if (deleteInput) deleteInput.value = 'on';
          row.style.display = 'none';
        }
      });

      document.addEventListener('DOMContentLoaded', function(){
        if (!getInput(typesPrefix + '-TOTAL_FORMS')) {
          const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
          fields.forEach(f => {
            const el = document.createElement('input');
            el.type = 'hidden';
            el.name = `${typesPrefix}-${f}`;
            el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
            typesArea.insertBefore(el, typesArea.firstChild);
          });
        }
        if (!getInput(alertsPrefix + '-TOTAL_FORMS')) {
          const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
          fields.forEach(f => {
            const el = document.createElement('input');
            el.type = 'hidden';
            el.name = `${alertsPrefix}-${f}`;
            el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
            alertsArea.insertBefore(el, alertsArea.firstChild);
          });
        }
      });
    })();

    // ---- end main IIFE ----
  })();
  </script>
</body>
</html>
