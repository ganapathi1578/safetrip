
{% load static %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Add Zone (hierarchical)</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 6px; margin-bottom: 12px; }
    .type-block { background: #fafafa; padding: 8px; margin-bottom: 8px; border-radius: 6px; }
    .alerts-list { margin-left: 18px; margin-top:8px; }
    .alert-row { margin-bottom:6px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .alert-row input[type="time"], .alert-row input[type="number"] { padding:4px; }
    button.add { margin-left:8px; }
    label { display:block; margin-top:6px; }
    .small { font-size: 0.9em; color: #555; }
    .remove-btn { background:#ffdddd; border:1px solid #d66; padding:4px 8px; cursor:pointer; border-radius:4px; }
    .add-btn { background:#ddffdd; border:1px solid #6d6; padding:4px 8px; cursor:pointer; border-radius:4px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Zone (Zone → ZoneTypes → ZoneAlerts)</h1>

    <form method="post" id="zone-form">
      {% csrf_token %}

      <div class="card">
        <h3>Zone</h3>
        {{ zone_form.as_p }}
      </div>

      <div class="card">
        <h3>Zone Types
          <button type="button" id="add-type" class="add-btn">+ Add Type</button>
        </h3>

        <div id="types-area">
          {{ types_formset.management_form }}
          {% for form in types_formset.forms %}
            <div class="type-block" data-type-index="{{ forloop.counter0 }}">
              <strong>Type #{{ forloop.counter }}</strong>
              <div>
                {{ form.name.label_tag }} {{ form.name }}
              </div>
              <div>
                {{ form.description.label_tag }} {{ form.description }}
              </div>

              <div class="alerts-list" id="alerts-for-type-{{ forloop.counter0 }}">
                <h4>Alerts
                  <button type="button" class="add-alert add-btn" data-type-index="{{ forloop.counter0 }}">+ Add Alert</button>
                </h4>
                <!-- if you want to render initial alert forms (edit mode) you can put them here -->
              </div>
            </div>
          {% endfor %}
        </div>

      </div>

      <!-- Alerts formset management (hidden) -->
      <div id="alerts-area" style="display:none;">
        {{ alerts_formset.management_form }}
      </div>

      <button type="submit">Save Zone + Types + Alerts</button>
    </form>
  </div>

<script>
(function(){
  // Prefill prefixes from Django formsets (rendered into template)
  const typesPrefix = "{{ types_formset.prefix }}";   // e.g., "types"
  const alertsPrefix = "{{ alerts_formset.prefix }}"; // e.g., "alerts"

  const typesArea = document.getElementById('types-area');
  const addTypeBtn = document.getElementById('add-type');
  const alertsArea = document.getElementById('alerts-area');

  // helper to find formset management inputs
  function getInput(name) { return document.querySelector('[name="'+name+'"]'); }
  function setInput(name, val){ const el = getInput(name); if(el) el.value = val; }
  function getTotalForms(prefix){ const el = getInput(prefix + '-TOTAL_FORMS'); return el ? parseInt(el.value || '0', 10) : 0; }

  // Create a new ZoneType block (client-side)
  function createTypeBlock(index){
    const wrapper = document.createElement('div');
    wrapper.className = 'type-block';
    wrapper.setAttribute('data-type-index', index);

    // build inner html with proper form input names for types formset
    wrapper.innerHTML = `
      <strong>Type #${index + 1}</strong>
      <div>
        <label for="id_${typesPrefix}-${index}-name">Name:</label>
        <input type="text" name="${typesPrefix}-${index}-name" id="id_${typesPrefix}-${index}-name" />
        <input type="hidden" name="${typesPrefix}-${index}-DELETE" value="" />
      </div>
      <div>
        <label for="id_${typesPrefix}-${index}-description">Description:</label>
        <textarea name="${typesPrefix}-${index}-description" id="id_${typesPrefix}-${index}-description" rows="2"></textarea>
      </div>

      <div class="alerts-list" id="alerts-for-type-${index}">
        <h4>Alerts
          <button type="button" class="add-alert add-btn" data-type-index="${index}">+ Add Alert</button>
        </h4>
      </div>
    `;
    return wrapper;
  }

  // Create an alert input row (these inputs are part of the alerts formset names)
  function createAlertRow(globalIndex, typeIndex){
    const row = document.createElement('div');
    row.className = 'alert-row';
    row.setAttribute('data-alert-index', globalIndex);

    // inputs must have names alerts-<i>-field to be understood by Django formset
    row.innerHTML = `
      <label>Start:</label>
      <input type="time" name="${alertsPrefix}-${globalIndex}-start_time" required />
      <label>End:</label>
      <input type="time" name="${alertsPrefix}-${globalIndex}-end_time" required />
      <label>Risk:</label>
      <input type="number" name="${alertsPrefix}-${globalIndex}-risk_points" min="0" max="100" required />
      <input type="hidden" name="${alertsPrefix}-${globalIndex}-type_index" value="${typeIndex}" />
      <input type="hidden" name="${alertsPrefix}-${globalIndex}-DELETE" value="" />
      <button type="button" class="remove-alert remove-btn">Remove</button>
    `;
    return row;
  }

  // Add-type button handler
  addTypeBtn.addEventListener('click', function(){
    let totalTypes = getTotalForms(typesPrefix);
    const newBlock = createTypeBlock(totalTypes);
    typesArea.appendChild(newBlock);
    // bump types TOTAL_FORMS
    setInput(typesPrefix + '-TOTAL_FORMS', totalTypes + 1);
  });

  // Delegate clicks for add-alert and remove-alert
  document.addEventListener('click', function(e){
    // add alert under a type
    if (e.target && e.target.matches('.add-alert')) {
      const typeIndex = e.target.getAttribute('data-type-index');
      // create new alert row
      let alertsTotal = getTotalForms(alertsPrefix);
      const alertRow = createAlertRow(alertsTotal, typeIndex);

      // append alertRow visually under corresponding type block's alerts-list
      const list = document.getElementById('alerts-for-type-' + typeIndex);
      if (list) {
        list.appendChild(alertRow);
      } else {
        // fallback: append to alerts-area
        alertsArea.appendChild(alertRow);
      }

      // increment TOTAL_FORMS for alerts formset
      setInput(alertsPrefix + '-TOTAL_FORMS', alertsTotal + 1);
    }

    // remove alert row (mark DELETE and hide)
    if (e.target && e.target.matches('.remove-alert')) {
      const row = e.target.closest('.alert-row');
      if (!row) return;
      // set DELETE hidden input to 'on' and hide the row
      const deleteInput = row.querySelector('input[name$="-DELETE"]');
      if (deleteInput) deleteInput.value = 'on';
      row.style.display = 'none';
    }
  });

  // Ensure management forms exist (in case upstream didn't render)
  document.addEventListener('DOMContentLoaded', function(){
    // types management
    if (!getInput(typesPrefix + '-TOTAL_FORMS')) {
      const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
      fields.forEach(f => {
        const el = document.createElement('input');
        el.type = 'hidden';
        el.name = `${typesPrefix}-${f}`;
        el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
        typesArea.insertBefore(el, typesArea.firstChild);
      });
    }

    // alerts management
    if (!getInput(alertsPrefix + '-TOTAL_FORMS')) {
      const fields = ['TOTAL_FORMS','INITIAL_FORMS','MIN_NUM_FORMS','MAX_NUM_FORMS'];
      fields.forEach(f => {
        const el = document.createElement('input');
        el.type = 'hidden';
        el.name = `${alertsPrefix}-${f}`;
        el.value = (f === 'TOTAL_FORMS' ? '0' : '0');
        alertsArea.insertBefore(el, alertsArea.firstChild);
      });
    }
  });

})();
</script>
</body>
</html>
