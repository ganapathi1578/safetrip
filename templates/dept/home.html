{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeTour ‚Äî Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'css/safetour.css' %}" />
  <link rel="stylesheet" href="{% static 'css/zone_management.css' %}" />
</head>
<body>
  <div id="map"></div>

  <!-- Top bar (Google maps style) -->
  <div class="top-bar" id="topBar">
    <div class="top-left">
      <div class="search-box">
        <input type="search" placeholder="Search map" aria-label="Search map">
        <button class="search-btn">üîç</button>
      </div>
    </div>
    <div class="top-center">
      <div class="pill-group">
        <button class="pill" id="openZoneTypes">Filters</button>
        <!-- <button class="pill" id="openTimeFilter">Time</button> -->
        <button class="pill" id="toggleTouristsBtn">Tourists</button>
        <button class="pill" id="applyFiltersBtn">Apply</button>
        <button class="pill" id="resetFiltersBtn">Reset</button>
      </div>
    </div>
    <div class="filters-dropdown" id="filtersDropdown" aria-hidden="true">
      <h4>Filters</h4>
      <div id="zoneTypeContainer">
        <strong>Zone Types</strong>
        <div id="zoneTypeList">Loading...</div>
      </div>

      <div style="margin-top:8px;">
        <strong>Time</strong>
        <div>
          <label><input type="radio" name="timeMode" value="current" checked> Current</label>
          <label><input type="radio" name="timeMode" value="all"> All</label>
          <label><input type="radio" name="timeMode" value="custom"> Custom</label>
        </div>
        <div id="customTimeInputs" style="display:none; margin-top:6px;">
          <input type="time" id="customStart"> to <input type="time" id="customEnd">
        </div>
      </div>

      <div style="margin-top:8px;">
        <label><input type="checkbox" id="showTourists"> Show Tourists (latest)</label>
      </div>
    </div>
  </div>

  <!-- Right side alerts panel -->
  <aside class="alerts-panel" id="alertsPanel">
    <div class="alerts-header"><strong>Alerts</strong></div>
    <div id="alertsList" class="alerts-list">
      <!-- Alerts will be rendered here -->
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{% static 'js/safetour.js' %}"></script>

  <script>
let map, zoneLayers = [], touristMarkers = [];

function initMap(){
  map = L.map('map').setView([23.73, 92.72], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);
}

async function fetchFilterOptions(){
  const res = await fetch('/api/filter_options/');
  const data = await res.json();
  const container = document.getElementById('zoneTypeList');
  container.innerHTML = '';
  data.zone_types.forEach(zt => {
    const id = 'zt_' + zt.id;
    const div = document.createElement('div');
    div.className = 'zone-type-item';
    div.innerHTML = `<label><input type="checkbox" value="${zt.id}" id="${id}"> ${zt.name} <span style="color:#888; font-size:12px"> ‚Äî ${zt.zone_name}</span></label>`;
    container.appendChild(div);
  });
}

function readFilters(){
  const checked = Array.from(document.querySelectorAll('#zoneTypeList input[type=checkbox]:checked')).map(el=>el.value);
  const timeMode = document.querySelector('input[name=timeMode]:checked').value;
  const customStart = document.getElementById('customStart').value;
  const customEnd = document.getElementById('customEnd').value;
  const showTourists = document.getElementById('showTourists') ? document.getElementById('showTourists').checked : false;
  return {zone_type_ids: checked, timeMode, customStart, customEnd, showTourists};
}

function clearMap(){
  zoneLayers.forEach(l=>map.removeLayer(l)); zoneLayers = [];
  touristMarkers.forEach(m=>map.removeLayer(m)); touristMarkers = [];
}

async function applyFilters(){
  const f = readFilters();
  clearMap();
  const params = new URLSearchParams();
  if(f.zone_type_ids.length) params.set('zone_type_ids', f.zone_type_ids.join(','));
  if(f.timeMode === 'current') params.set('mode','current');
  else if(f.timeMode === 'all') params.set('mode','all');
  else if(f.timeMode === 'custom'){
    params.set('mode','custom');
    if(f.customStart) params.set('start_time', f.customStart.substring(0,5));
    if(f.customEnd) params.set('end_time', f.customEnd.substring(0,5));
  }
  if(f.showTourists) params.set('include_latest_tourists','1');

  const res = await fetch('/api/alerts/?' + params.toString());
  const json = await res.json();

  // draw alerts (as circles centered on zone lat/lng)
  json.alerts.forEach(a => {
    const radius = a.zone.radius || 300;
    const circle = L.circle([a.zone.latitude, a.zone.longitude], {radius: radius, weight:2});
    circle.bindPopup(`<strong>${a.zone.name}</strong><br>${a.zone_type.name}<br>${a.start_time} - ${a.end_time}<br>Risk: ${a.risk_points}`);
    circle.addTo(map);
    zoneLayers.push(circle);
  });

  // optionally draw latest tourists returned in the same response
  if(json.latest_tourists){
    json.latest_tourists.forEach(t => {
      const m = L.marker([t.latitude, t.longitude]);
      m.bindPopup(`<strong>${t.name}</strong><br>${new Date(t.timestamp).toLocaleString()}`);
      m.addTo(map);
      touristMarkers.push(m);
    });
  }

  renderAlertsList(json.alerts);
}

function renderAlertsList(alerts){
  const container = document.getElementById('alertsList');
  container.innerHTML = '';
  if(!alerts.length){ container.innerHTML = '<div class="alert-item">No alerts found for selected filters.</div>'; return; }
  alerts.forEach(a=>{
    const div = document.createElement('div');
    div.className = 'alert-item';
    div.innerHTML = `<div><strong>${a.zone.name} ‚Äî ${a.zone_type.name}</strong></div>
                     <div class="meta">${a.start_time} - ${a.end_time} ‚Ä¢ Risk: ${a.risk_points}</div>`;
    div.addEventListener('click', ()=>{
      map.flyTo([a.zone.latitude, a.zone.longitude], 15, {duration:0.6});
    });
    container.appendChild(div);
  });
}

function bindUI(){
  const applyBtn = document.getElementById('applyFiltersBtn');
  if(applyBtn) applyBtn.addEventListener('click', applyFilters);
  const resetBtn = document.getElementById('resetFiltersBtn');
  if(resetBtn) resetBtn.addEventListener('click', async ()=>{
    document.querySelectorAll('#zoneTypeList input[type=checkbox]').forEach(cb=>cb.checked=false);
    const current = document.querySelector('input[name=timeMode][value=current]'); if(current) current.checked = true;
    const customInputs = document.getElementById('customTimeInputs'); if(customInputs) customInputs.style.display='none';
    const showTouristsEl = document.getElementById('showTourists'); if(showTouristsEl) showTouristsEl.checked = false;
    await applyFilters();
  });

  // open zone types / time sections
  const openZone = document.getElementById('openZoneTypes');
  const openTime = document.getElementById('openTimeFilter');
  const toggleTouristsBtn = document.getElementById('toggleTouristsBtn');
  const filtersDropdown = document.getElementById('filtersDropdown');
  // zone button: open dropdown and scroll to zone list
  if(openZone) openZone.addEventListener('click', ()=>{
    if(filtersDropdown) filtersDropdown.setAttribute('aria-hidden','false');
    const z = document.getElementById('zoneTypeList'); if(z) z.scrollIntoView({behavior:'smooth', block:'start'});
  });
  // time button: open dropdown and scroll to time controls
  if(openTime) openTime.addEventListener('click', ()=>{
    if(filtersDropdown) filtersDropdown.setAttribute('aria-hidden','false');
    const t = document.getElementById('timeContainer'); if(t) t.scrollIntoView({behavior:'smooth', block:'center'});
  });
  // tourists button: toggle the showTourists checkbox, visually indicate, and apply filters
  if(toggleTouristsBtn) toggleTouristsBtn.addEventListener('click', async ()=>{
    const s = document.getElementById('showTourists');
    if(s){ s.checked = !s.checked; toggleTouristsBtn.classList.toggle('active', s.checked); await applyFilters(); }
  });
  // ensure checkbox and pill stay in sync; changing checkbox updates pill and triggers filters
  const showTouristsEl = document.getElementById('showTourists');
  if(showTouristsEl){
    showTouristsEl.addEventListener('change', async ()=>{
      toggleTouristsBtn.classList.toggle('active', showTouristsEl.checked);
      await applyFilters();
    });
  }

  // close when clicking outside
  document.addEventListener('click', (e)=>{
    const dd = document.getElementById('filtersDropdown');
    const topBar = document.querySelector('.top-bar');
    if(!dd || dd.getAttribute('aria-hidden') === 'true') return;
    if(!dd.contains(e.target) && !topBar.contains(e.target)) dd.setAttribute('aria-hidden','true');
  });

  document.querySelectorAll('input[name=timeMode]').forEach(r=> r.addEventListener('change', (e)=>{
    const ct = document.getElementById('customTimeInputs'); if(ct) ct.style.display = (e.target.value==='custom') ? 'block' : 'none';
  }));

  // search handler (Nominatim) ‚Äî pans map to first result and places temporary marker
  const searchInput = document.querySelector('.search-box input[type=search]');
  const searchBtn = document.querySelector('.search-box .search-btn');
  let searchMarker = null;
  async function doSearch(){
    const q = searchInput && searchInput.value && searchInput.value.trim();
    if(!q) return;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    try{
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      const results = await r.json();
      if(!results || !results.length) return;
      const first = results[0];
      const lat = parseFloat(first.lat), lon = parseFloat(first.lon);
      map.flyTo([lat, lon], 15, {duration:0.7});
      if(searchMarker) map.removeLayer(searchMarker);
      searchMarker = L.marker([lat, lon]).addTo(map).bindPopup(first.display_name).openPopup();
    }catch(e){ console.error('search error', e); }
  }
  if(searchBtn) searchBtn.addEventListener('click', doSearch);
  if(searchInput) searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') doSearch(); });
}

window.addEventListener('DOMContentLoaded', async ()=>{
  initMap();
  await fetchFilterOptions();
  bindUI();
  applyFilters();
});
  </script>
</body>
</html>