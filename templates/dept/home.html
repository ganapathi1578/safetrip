{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SafeTour ‚Äî Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="{% static 'css/zone_management.css' %}" />
  <style>
    /* Zone management / top-bar styles extracted from template */
    :root{
      --card-bg: rgba(255,255,255,0.98);
      --shadow: 0 8px 24px rgba(0,0,0,0.12);
      --primary: #1f6feb;
      --muted: #6b7280;
    }

    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }

    #map {
      width: 100%;
      height: 100vh;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* Top bar similar to Google Maps - FIXED VERSION */
    .top-bar {
      position: absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 1200px;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      z-index: 1100;
      box-sizing: border-box;
    }
    
    .top-left { 
      flex: 1;
      min-width: 200px;
    }
    
    .search-box { 
      display: flex; 
      align-items: center; 
      gap: 8px;
      width: 100%;
    }
    
    .search-box input[type=search] {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      outline: none;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
      flex: 1;
    }
    
    .search-box input[type=search]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
    }
    
    .search-btn {
      background: var(--primary);
      border: 0;
      cursor: pointer;
      font-size: 16px;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      transition: background-color 0.2s ease;
      min-width: 44px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-btn:hover {
      background-color: #0d5bd9;
    }
    
    .top-center { 
      flex: 0 0 auto;
      white-space: nowrap;
    }
    
    .pill-group { 
      display: flex; 
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .pill {
      background: #fff;
      border: 1px solid #e6e7ea;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
      font-size: 14px;
      white-space: nowrap;
    }
    
    .pill:hover { 
      box-shadow: 0 6px 18px rgba(0,0,0,0.06); 
    }
    
    .pill:active { 
      background: var(--primary); 
      color: #fff; 
      border-color: transparent; 
    }

    /* Filters dropdown ‚Äî anchored below the top bar */
    .filters-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      width: 520px;
      max-width: calc(100% - 40px);
      background: var(--card-bg);
      border-radius: 10px;
      padding: 16px;
      box-shadow: var(--shadow);
      z-index: 1200;
      display: none;
      box-sizing: border-box;
    }
    
    .filters-dropdown[aria-hidden="false"] { 
      display: block; 
    }
    
    .filters-dropdown h4 { 
      margin: 0 0 12px 0; 
      font-size: 16px; 
    }
    
    .zone-type-item { 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      margin: 8px 0; 
    }
    
    .filter-actions { 
      margin-top: 16px; 
      display: flex; 
      gap: 8px; 
      justify-content: flex-end; 
    }
    
    .btn { 
      padding: 10px 16px; 
      border-radius: 6px; 
      border: 0; 
      cursor: pointer; 
      background: var(--primary); 
      color: #fff; 
      font-size: 14px;
    }
    
    .btn-outline { 
      background: transparent; 
      border: 1px solid #ccc; 
      color: #333; 
    }
    
    .alerts-list { 
      margin-top: 12px; 
      max-height: 220px; 
      overflow: auto; 
    }
    
    .alert-item { 
      padding: 12px; 
      border-radius: 6px; 
      margin-bottom: 8px; 
      background: #fff; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.04);
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .alert-item:hover {
      background-color: #f8f9fa;
    }
    
    .alert-item .meta { 
      font-size: 12px; 
      color: var(--muted); 
    }

    /* Right side details panel */
    .details-panel {
      position: absolute;
      right: 12px;
      top: 86px;
      width: 340px;
      max-width: calc(100% - 24px);
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 16px;
      z-index: 1100;
      max-height: calc(100vh - 120px);
      overflow-y: auto;
      box-sizing: border-box;
    }
    
    .details-header { 
      margin-bottom: 16px; 
      font-weight: bold;
      font-size: 18px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e6e7ea;
    }
    
    .details-content .empty-msg { 
      font-size: 14px; 
      color: #666; 
      text-align: center;
      padding: 20px 0;
    }

    /* Responsive adjustments */
    @media (max-width: 1000px) {
      .top-bar { 
        width: calc(100% - 24px); 
        left: 12px; 
        transform: none; 
        border-radius: 8px;
        flex-wrap: wrap;
        gap: 12px;
      }
      
      .top-left {
        min-width: 100%;
        order: 1;
      }
      
      .top-center {
        order: 2;
        min-width: 100%;
      }
      
      .pill-group {
        justify-content: center;
      }
      
      .filters-dropdown { 
        left: 12px; 
        transform: none; 
        width: calc(100% - 24px); 
      }
      
      .details-panel {
        width: calc(100% - 24px);
        right: 12px;
        left: 12px;
        top: auto;
        bottom: 12px;
        max-height: 40vh;
      }
    }

    @media (max-width: 600px) {
      .top-bar {
        padding: 8px 12px;
      }
      
      .pill {
        padding: 6px 12px;
        font-size: 13px;
      }
      
      .search-box input[type=search] {
        padding: 8px 12px;
      }
      
      .search-btn {
        padding: 8px 12px;
        min-width: 40px;
        height: 36px;
      }
    }

    /* Remove conflicting styles that were causing layout issues */
    .cluster-legend { 
      font-size: 12px; 
      margin-top: 12px; 
    }
    
    .cluster-legend .dot { 
      display: inline-block; 
      width: 12px; 
      height: 12px; 
      border-radius: 6px; 
      margin-right: 6px; 
      vertical-align: middle; 
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Top bar (Google maps style) -->
  <div class="top-bar" id="topBar">
    <div class="top-left">
      <div class="search-box">
        <input type="search" placeholder="Search location..." aria-label="Search map">
        <button class="search-btn">üîç</button>
      </div>
    </div>
    <div class="top-center">
      <div class="pill-group">
        <button class="pill" id="openZoneTypes">Filters</button>
        <button class="pill" id="toggleTouristsBtn">Clusters</button>
        <button class="pill" id="applyFiltersBtn">Apply</button>
        <button class="pill" id="resetFiltersBtn">Reset</button>
      </div>
    </div>

    <!-- Filters dropdown (hidden by default using aria-hidden) -->
    <div class="filters-dropdown" id="filtersDropdown" aria-hidden="true">
      <h4>Filters</h4>
      <div id="zoneTypeContainer">
        <strong>Zone Types</strong>
        <div id="zoneTypeList">Loading...</div>
      </div>

      <div style="margin-top:16px;">
        <strong>Time</strong>
        <div style="margin-top:8px;">
          <label style="margin-right:12px;"><input type="radio" name="timeMode" value="current" checked> Current</label>
          <label style="margin-right:12px;"><input type="radio" name="timeMode" value="all"> All</label>
          <label><input type="radio" name="timeMode" value="custom"> Custom</label>
        </div>
        <div id="customTimeInputs" style="display:none; margin-top:10px;">
          <input type="time" id="customStart" style="padding:6px; border:1px solid #ddd; border-radius:4px;"> 
          <span style="margin:0 8px;">to</span>
          <input type="time" id="customEnd" style="padding:6px; border:1px solid #ddd; border-radius:4px;">
        </div>
      </div>

      <div style="margin-top:16px;">
        <label><input type="checkbox" id="showClusters" checked> Show Clusters (default ON)</label>
      </div>

      <div style="margin-top:16px;">
        <strong>Cluster Filters</strong>
        <div id="clusterFilterList" style="margin-top:8px;">Loading clusters...</div>
        <div class="cluster-legend" id="clusterLegend"></div>
      </div>

      <div class="filter-actions">
        <button class="btn" id="applyFiltersBtnDropdown">Apply Filters</button>
        <button class="btn btn-outline" id="closeFiltersBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- Right side details panel -->
  <aside class="details-panel" id="detailsPanel">
    <div class="details-header">Details</div>
    <div id="detailsContent" class="details-content">
      <div class="empty-msg">Select a marker or alert to view details.</div>
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
// ... (your existing JavaScript code remains exactly the same) ...
/* ---------- main JS (keeps all original features + clustering) ---------- */
let map;
let zoneLayers = [];
let touristMarkers = [];
let clusterColors = {}; // cluster_id -> color
let displayedClusterIds = new Set(); // which clusters to show (from UI)
let showClusters = true;

/* small helper to create visually distinct colors */
function getColorForCluster(clusterId){
  if(clusterColors[clusterId]) return clusterColors[clusterId];
  const h = (clusterId * 137) % 360;
  const color = `hsl(${h}, 70%, 45%)`;
  clusterColors[clusterId] = color;
  return color;
}

/* Toggle helper */
function toggleFilters(show) {
  const dd = document.getElementById('filtersDropdown');
  if (!dd) return;
  dd.setAttribute("aria-hidden", show ? "false" : "true");
  dd.style.display = show ? "block" : "none";
}

/* Map init */
function initMap(){
  map = L.map('map').setView([23.73, 92.72], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
  }).addTo(map);
}

/* Fetch filter options (zone types) */
async function fetchFilterOptions(){
  try {
    const res = await fetch('/api/filter_options/');
    if(!res.ok) throw new Error('Failed to load filter options');
    const data = await res.json();
    const container = document.getElementById('zoneTypeList');
    container.innerHTML = '';
    if(!data.zone_types || !data.zone_types.length){
      container.innerHTML = '<div style="color:#666">No zone types found.</div>';
      return;
    }
    data.zone_types.forEach(zt => {
      const id = 'zt_' + zt.id;
      const div = document.createElement('div');
      div.className = 'zone-type-item';
      div.innerHTML = `<label><input type="checkbox" value="${zt.id}" id="${id}"> ${escapeHtml(zt.name)} <span style="color:#888; font-size:12px"> ‚Äî ${escapeHtml(zt.zone_name || '')}</span></label>`;
      container.appendChild(div);
    });
  } catch (err) {
    console.error('fetchFilterOptions error', err);
    const container = document.getElementById('zoneTypeList');
    if(container) container.innerHTML = '<div style="color:#a00">Failed to load zone types.</div>';
  }
}

/* Read UI filter values */
function readFilters(){
  const checked = Array.from(document.querySelectorAll('#zoneTypeList input[type=checkbox]:checked')).map(el=>el.value);
  const timeModeEl = document.querySelector('input[name=timeMode]:checked');
  const timeMode = timeModeEl ? timeModeEl.value : 'current';
  const customStart = (document.getElementById('customStart') || {}).value || '';
  const customEnd = (document.getElementById('customEnd') || {}).value || '';
  const showClustersEl = document.getElementById('showClusters');
  const showClustersChecked = showClustersEl ? showClustersEl.checked : true;
  return {zone_type_ids: checked, timeMode, customStart, customEnd, showClusters: showClustersChecked};
}

/* Clear map layers */
function clearMap(){
  zoneLayers.forEach(l=>{ try{ map.removeLayer(l); }catch(e){} });
  zoneLayers = [];
  touristMarkers.forEach(m=>{ try{ map.removeLayer(m); }catch(e){} });
  touristMarkers = [];
  if(window._searchMarker){ try { map.removeLayer(window._searchMarker); } catch(e){} window._searchMarker = null; }
}

/* Populate cluster filter UI (list of available cluster ids) */
function populateClusterFilterUI(clusters){
  const container = document.getElementById('clusterFilterList');
  const legend = document.getElementById('clusterLegend');
  container.innerHTML = '';
  legend.innerHTML = '';
  if(!Array.isArray(clusters) || clusters.length===0){
    container.innerHTML = '<div class="empty-msg">No clusters found.</div>';
    return;
  }

  clusters.forEach(c => {
    const id = `cluster_cb_${c.cluster_id}`;
    const div = document.createElement('div');
    div.innerHTML = `<label><input type="checkbox" id="${id}" value="${c.cluster_id}" checked> Cluster ${c.cluster_id} (${c.members.length})</label>`;
    container.appendChild(div);
    const dot = document.createElement('span');
    dot.className = 'dot';
    dot.style.background = getColorForCluster(c.cluster_id);
    dot.style.display = 'inline-block';
    dot.style.width = '12px';
    dot.style.height = '12px';
    dot.style.borderRadius = '8px';
    dot.style.marginRight = '6px';
    const label = document.createElement('span');
    label.textContent = `Cluster ${c.cluster_id}`;
    const wrap = document.createElement('div');
    wrap.appendChild(dot);
    wrap.appendChild(label);
    legend.appendChild(wrap);
  });

  displayedClusterIds = new Set(clusters.map(c=>String(c.cluster_id)));

  container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change', (e)=>{
      const val = String(e.target.value);
      if(e.target.checked) displayedClusterIds.add(val);
      else displayedClusterIds.delete(val);
      fetchAndRenderClusters();
    });
  });
}

/* Fetch clusters and unclustered tourists from backend then render them */
async function fetchAndRenderClusters(){
  const f = readFilters();
  if(!f.showClusters){
    clearClusterMarkersOnly();
    return;
  }

  try {
    const params = new URLSearchParams();
    params.set('mode', f.timeMode || 'current');
    if(f.timeMode === 'custom'){
      if(f.customStart) params.set('start_time', f.customStart);
      if(f.customEnd) params.set('end_time', f.customEnd);
    }
    const res = await fetch('/api/clusters/?' + params.toString());
    if(!res.ok) throw new Error('Failed to load clusters');
    const json = await res.json();

    populateClusterFilterUI(json.clusters || []);

    clearClusterMarkersOnly();

    (json.clusters || []).forEach(cluster => {
      const cId = String(cluster.cluster_id);
      if(!displayedClusterIds.has(cId)) return;
      const color = getColorForCluster(cluster.cluster_id);
      (cluster.members || []).forEach(m => {
        if(m.latitude == null || m.longitude == null) return;
        const marker = L.circleMarker([m.latitude, m.longitude], {
          radius: 6,
          color: color,
          fillColor: color,
          fillOpacity: 0.85,
          weight: 1
        }).addTo(map);
        marker.bindPopup(`<strong>${escapeHtml(m.name || m.tourist_id)}</strong><br>Cluster ${cluster.cluster_id}<br>${new Date(m.timestamp).toLocaleString()}`);
        marker.on('click', () => {
          marker.openPopup();
          if(m.tourist_id) showTouristDetails(m.tourist_id);
        });
        touristMarkers.push(marker);
      });

      if(cluster.center_latitude != null && cluster.center_longitude != null){
        const center = L.circleMarker([cluster.center_latitude, cluster.center_longitude], {
          radius: 9,
          color: '#000',
          fillColor: getColorForCluster(cluster.cluster_id),
          fillOpacity: 1,
          weight: 1
        }).addTo(map);
        center.bindPopup(`<strong>Cluster ${cluster.cluster_id}</strong><br>Members: ${cluster.members.length}`);
        touristMarkers.push(center);
      }
    });

    (json.unclustered_tourists || []).forEach(t => {
      if(t.latitude == null || t.longitude == null) return;
      const marker = L.circleMarker([t.latitude, t.longitude], {
        radius: 5,
        color: '#000',
        fillColor: '#000',
        fillOpacity: 0.8,
        weight: 0.8
      }).addTo(map);
      marker.bindPopup(`<strong>${escapeHtml(t.name || t.tourist_id)}</strong><br>Not in cluster<br>${new Date(t.timestamp).toLocaleString()}`);
      marker.on('click', () => { marker.openPopup(); if(t.tourist_id) showTouristDetails(t.tourist_id); });
      touristMarkers.push(marker);
    });

  } catch (err) {
    console.error('fetchAndRenderClusters error', err);
  }
}

/* remove only the tourist markers (cluster markers etc) */
function clearClusterMarkersOnly(){
  touristMarkers.forEach(m => { try{ map.removeLayer(m); }catch(e){} });
  touristMarkers = [];
}

/* Apply filters: fetch alerts and (then) clusters, draw on map */
async function applyFilters(){
  const f = readFilters();
  clearMap();
  const params = new URLSearchParams();
  if(f.zone_type_ids.length) params.set('zone_type_ids', f.zone_type_ids.join(','));
  if(f.timeMode === 'current') params.set('mode','current');
  else if(f.timeMode === 'all') params.set('mode','all');
  else if(f.timeMode === 'custom'){
    params.set('mode','custom');
    if(f.customStart) params.set('start_time', f.customStart.substring(0,5));
    if(f.customEnd) params.set('end_time', f.customEnd.substring(0,5));
  }

  try {
    const res = await fetch('/api/alerts/?' + params.toString());
    if(!res.ok) throw new Error('alerts API failed: ' + res.status);
    const json = await res.json();

    if(Array.isArray(json.alerts)){
      json.alerts.forEach(a => {
        const lat = a.zone && a.zone.latitude;
        const lng = a.zone && a.zone.longitude;
        if(lat == null || lng == null) return;
        const radius = (a.zone && a.zone.radius) || 300;
        const circle = L.circle([lat, lng], {radius: radius, weight:2});
        const popupHtml = `<strong>${escapeHtml(a.zone.name || 'Zone')}</strong><br>${escapeHtml(a.zone_type && a.zone_type.name || '')}<br>${escapeHtml(a.start_time || '')} - ${escapeHtml(a.end_time || '')}<br>Risk: ${escapeHtml(String(a.risk_points || ''))}`;
        circle.bindPopup(popupHtml);
        circle.addTo(map);
        zoneLayers.push(circle);

        circle.on('click', ()=> {
          renderAlertDetails(a);
        });
      });
    }

    renderAlertsList(Array.isArray(json.alerts) ? json.alerts : []);
  } catch (err) {
    console.error('applyFilters error', err);
    const container = document.getElementById('detailsContent');
    if(container) container.innerHTML = `<div class="empty-msg" style="color:#a00">Failed to load alerts.</div>`;
  }

  await fetchAndRenderClusters();
}

/* Fetch and render tourist details into right panel */
async function showTouristDetails(userId) {
  if(!userId) return;
  try {
    const res = await fetch(`/tourist/${encodeURIComponent(userId)}/details/`);
    if (!res.ok) {
      console.error("Failed to fetch tourist details", res.status);
      const panel = document.getElementById("detailsContent");
      panel.innerHTML = `<div class="empty-msg" style="color:#a00">Failed to load details (status ${res.status}).</div>`;
      return;
    }
    const data = await res.json();

    const panel = document.getElementById("detailsContent");
    const t = data.tourist || {};
    const itin = data.current_itinerary;
    const trips = Array.isArray(data.trips) ? data.trips : [];

    panel.innerHTML = `
      <div style="font-weight:700; font-size:16px; margin-bottom:6px;">${escapeHtml(t.name || t.userid || 'Tourist')}</div>

      <div style="font-size:13px; color:#444; margin-bottom:6px;">
        <div><strong>Userid:</strong> ${escapeHtml(t.userid || '')}</div>
        <div><strong>Email:</strong> ${escapeHtml(t.email || 'N/A')}</div>
        <div><strong>Mobile:</strong> ${escapeHtml(t.mobile_no || 'N/A')}</div>
        <div><strong>DOB:</strong> ${escapeHtml(t.dob || 'N/A')}</div>
        <div><strong>Aadhaar:</strong> ${escapeHtml(t.aadhaar_no || 'N/A')}</div>
        <div><strong>Passport:</strong> ${escapeHtml(t.passport_no || 'N/A')}</div>
      </div>

      <div style="border-top:1px solid #eee; padding-top:8px; margin-top:8px;">
        <div style="font-weight:600; margin-bottom:6px;">Current itinerary</div>
        ${itin ? `
          <div style="font-size:13px;">
            <div><strong>${escapeHtml(itin.title)}</strong></div>
            <div>${escapeHtml(itin.start_date || '')} ‚Üí ${escapeHtml(itin.end_date || '')}</div>
            <div>${escapeHtml(itin.base_location || '')}</div>
          </div>
        ` : `<div style="color:#666; font-size:13px;">No active itinerary</div>`}
      </div>

      <div style="border-top:1px solid #eee; padding-top:8px; margin-top:8px;">
        <div style="font-weight:600; margin-bottom:6px;">Trips</div>
        ${trips.length ? `
          <ul style="padding-left:18px; margin:0;">
            ${trips.map(trip => `<li style="margin-bottom:6px;"><strong>${escapeHtml(trip.trip_title)}</strong><br><small>${escapeHtml(trip.start_location)} ‚Üí ${escapeHtml(trip.end_location)} ‚Ä¢ ${escapeHtml(trip.start_time)} ‚Üí ${escapeHtml(trip.end_time)}</small></li>`).join('')}
          </ul>
        ` : `<div style="color:#666; font-size:13px;">No trips for current itinerary</div>`}
      </div>
    `;
  } catch (err) {
    console.error('showTouristDetails error', err);
    const panel = document.getElementById("detailsContent");
    panel.innerHTML = `<div class="empty-msg" style="color:#a00">Error loading details.</div>`;
  }
}

/* Render single alert details into right panel */
function renderAlertDetails(a){
  if(!a || !a.zone) return;
  const panel = document.getElementById('detailsContent');
  panel.innerHTML = `
    <div style="font-weight:700; margin-bottom:6px;">${escapeHtml(a.zone.name || 'Alert')}</div>
    <div style="font-size:13px; color:#444;">
      <div><strong>Type:</strong> ${escapeHtml(a.zone_type && a.zone_type.name || 'N/A')}</div>
      <div><strong>When:</strong> ${escapeHtml(a.start_time || '')} ‚Üí ${escapeHtml(a.end_time || '')}</div>
      <div><strong>Risk:</strong> ${escapeHtml(String(a.risk_points || ''))}</div>
      <div style="margin-top:8px;"><strong>Description:</strong><div style="color:#666; margin-top:6px;">${escapeHtml(a.description || 'No description')}</div></div>
    </div>
  `;

  const possibleTouristId = a.tourist_id || (a.tourist && (a.tourist.userid || a.tourist.id));
  if(possibleTouristId){
    setTimeout(()=> showTouristDetails(possibleTouristId), 600);
  }
}

/* Render small alerts list in right panel */
function renderAlertsList(alerts){
  const listTarget = document.getElementById('detailsContent');
  listTarget.innerHTML = '';
  if(!Array.isArray(alerts) || alerts.length === 0){
    listTarget.innerHTML = '<div class="empty-msg">No alerts found for selected filters.</div>';
    return;
  }

  alerts.forEach(a => {
    const node = document.createElement('div');
    node.className = 'alert-item';
    const title = a.zone && a.zone.name ? a.zone.name : 'Alert';
    const meta = `${a.start_time || ''} - ${a.end_time || ''} ‚Ä¢ Risk: ${a.risk_points || ''}`;
    node.innerHTML = `<div><strong>${escapeHtml(title)}</strong></div><div class="meta">${escapeHtml(meta)}</div>`;
    node.addEventListener('click', () => {
      if(a.zone && a.zone.latitude != null && a.zone.longitude != null){
        map.flyTo([a.zone.latitude, a.zone.longitude], 15, {duration:0.6});
      }
      renderAlertDetails(a);
    });
    listTarget.appendChild(node);
  });
}

/* UI bindings (preserves old features, with improved dropdown behavior and clustering) */
function bindUI(){
  const applyBtn = document.getElementById('applyFiltersBtn');
  if(applyBtn) applyBtn.addEventListener('click', applyFilters);

  const resetBtn = document.getElementById('resetFiltersBtn');
  if(resetBtn) resetBtn.addEventListener('click', async ()=> {
    document.querySelectorAll('#zoneTypeList input[type=checkbox]').forEach(cb=>cb.checked=false);
    const current = document.querySelector('input[name=timeMode][value=current]'); if(current) current.checked = true;
    const customInputs = document.getElementById('customTimeInputs'); if(customInputs) customInputs.style.display='none';
    const showClustersEl = document.getElementById('showClusters'); if(showClustersEl) showClustersEl.checked = true;
    await applyFilters();
  });

  const openZone = document.getElementById('openZoneTypes');
  const dd = document.getElementById('filtersDropdown');
  const topBar = document.getElementById('topBar');

  if(openZone && dd){
    openZone.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = dd.getAttribute('aria-hidden') === 'true' || dd.style.display === 'none';
      toggleFilters(isHidden);
    });

    dd.addEventListener('click', (e) => e.stopPropagation());
    dd.addEventListener('touchstart', (e) => e.stopPropagation(), { passive: true });
  }

  const closeIfOutside = (e) => {
    const ddVisible = dd && dd.getAttribute('aria-hidden') === 'false';
    if(!ddVisible) return;
    if(!(dd.contains(e.target) || topBar.contains(e.target))){
      toggleFilters(false);
    }
  };
  document.addEventListener('click', closeIfOutside);
  document.addEventListener('touchstart', closeIfOutside, { passive: true });

  document.addEventListener('keydown', (e) => { if(e.key === 'Escape') toggleFilters(false); });

  const toggleTouristsBtn = document.getElementById('toggleTouristsBtn');
  if(toggleTouristsBtn){
    toggleTouristsBtn.addEventListener('click', async ()=> {
      const chk = document.getElementById('showClusters');
      if(chk){
        chk.checked = !chk.checked;
        toggleTouristsBtn.classList.toggle('active', chk.checked);
        await applyFilters();
      }
    });
  }

  const showClustersEl = document.getElementById('showClusters');
  if(showClustersEl){
    showClustersEl.addEventListener('change', async ()=> {
      document.getElementById('toggleTouristsBtn').classList.toggle('active', showClustersEl.checked);
      await applyFilters();
    });
  }

  document.querySelectorAll('input[name=timeMode]').forEach(r => r.addEventListener('change', (e)=>{
    const ct = document.getElementById('customTimeInputs'); if(ct) ct.style.display = (e.target.value === 'custom') ? 'block' : 'none';
  }));

  const searchInput = document.querySelector('.search-box input[type=search]');
  const searchBtn = document.querySelector('.search-box .search-btn');
  async function doSearch(){
    const q = searchInput && searchInput.value && searchInput.value.trim();
    if(!q) return;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
    try{
      const r = await fetch(url, {headers:{'Accept':'application/json'}});
      const results = await r.json();
      if(!results || !results.length) return;
      const first = results[0];
      const lat = parseFloat(first.lat), lon = parseFloat(first.lon);
      map.flyTo([lat, lon], 15, {duration:0.7});
      if(window._searchMarker) { try { map.removeLayer(window._searchMarker); } catch(e){} }
      window._searchMarker = L.marker([lat, lon]).addTo(map).bindPopup(first.display_name).openPopup();
    }catch(e){ console.error('search error', e); }
  }
  if(searchBtn) searchBtn.addEventListener('click', doSearch);
  if(searchInput) searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') { e.preventDefault(); doSearch(); } });
}

/* small helper to escape HTML when injecting strings */
function escapeHtml(str){
  if(str === null || str === undefined) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

/* startup */
let clusterRefreshInterval = null;
window.addEventListener('DOMContentLoaded', async ()=>{
  initMap();
  await fetchFilterOptions();
  bindUI();
  await applyFilters();

  if(clusterRefreshInterval) clearInterval(clusterRefreshInterval);
  clusterRefreshInterval = setInterval(() => {
    fetchAndRenderClusters();
  }, 20000);
});
  </script>
</body>
</html>